# Note

Notes may be helpful or not. Please read if you think it's interesting

## Possible to-do list

Currently the Rocket Chip with prefetcher is not quite stable. Some benchmark may fail. Sadly the emulator does not give out any error message, but I suspect this is related with some address violations, such as prefetch IO region (seems impossible because I've add code to check that), prefetch debug ROM or boot ROM (which seems also impossible for same reason), or other violations.


Try to add a queue between the prefetcher and the cache seems interesting. Now the prefetcher follows DecoupledIO handshake protocol so it shouldn't be too hard. 


## Rocket Chip

To understand Rocket core's pipeline, an article from lowRISC (https://www.lowrisc.org/docs/tagged-memory-v0.1/rocket-core/) is a good start point. Sadly it seems lowRISC does not care about their website. At this time, this webpage is still accessible but all image links are broken. A snapshot can be found at ```doc```.

## Chisel, Firrtl, Verilator

You don't need to install Chisel if you just want to run/modify Rocket Chip. it comes with its own Chisel library.

Chisel is an interesting HDL. To learn Chisel, you need to have ome understanding about hardware and HDL (generally means you know VHDL or Verilog), un-learn it, then go back to Chisel. Unlike conventional HDL such as Verilog, Chisel is more like a library of scala, this means sometimes a straight-forward error, such as DecoupledIO type mismatch, will not raise when chisel is compiling. Such error may raise untill verilator checks generated Verilog file (usually 100k+ lines). 

Verilator is quite reliable. Sometimes C++ code generated by verilator will fail to compile, a simple ```make clean``` would fix this.

Chisel's documentation is not quite satisfying. I would recommend read the source code if official docs are not helpful (which always happens). 


## Debug controller

The debug controller will load your program into memory, and hijack the rocket core for every 40000ns (or every 20000 cycles). It will instruct core communicate with emulator (tohost section, see following). If you see your PC drop into about ```0x00000800```(debug ROM), don't worry, that's not your code.

BTW it will flush icache multiple times when the debug controller takes the control.


## tohost section
The binary communicates with emulator by a specified ```tohost``` section. For more details, read the linker script ```riscv-tools/riscv-tests/benchmarks/common/test.ld```

## Common bugs
Here are general suggestions when face an error. See if they are helpful

### assert at TileLink ```Monitor.scala```
Usually because some incorrect address is sent to TileLink. In Rocket-Chip, memory region is at ```0x80000000``` or higher. Please check. Detailed address map is generated at emulator compile time, or you can find at ```rocket-chip/emulator/generated-src/emulator-xxxxxxxxxxxx(too long)-YourConfig.dts```



